using System.Collections;
using TMPro;
using UnityEditor.VersionControl;
using UnityEngine;
using UnityEngine.Networking;

public class ProxyServerAI : MonoBehaviour
{
    public TMP_InputField inputField;
    public TextMeshProUGUI responseText;
    public Animator characterAnimator;

    private string endpoint = "https://proxy-groq.onrender.com/chat";

    public void Update()
    {
        if (Input.GetKeyDown(KeyCode.Return))
        {
            OnSendMessage();
        }
    }

    public void OnSendMessage()
    {
        string message = inputField.text;
        inputField.text = "";
        if (!string.IsNullOrEmpty(message))
        {
            StartCoroutine(SendMessageToServer(message));
        }
    }
    IEnumerator SendMessageToServer(string message)
    {
        responseText.text = "Думаю...";

        string jsonBody = $"{{\"message\": \"{message} +  говори полностью русском языке\"}}";
        byte[] bodyRaw = System.Text.Encoding.UTF8.GetBytes(jsonBody);

        UnityWebRequest request = new UnityWebRequest(endpoint, "POST");
        request.uploadHandler = new UploadHandlerRaw(bodyRaw);
        request.downloadHandler = new DownloadHandlerBuffer();
        request.SetRequestHeader("Content-Type", "application/json");


        yield return request.SendWebRequest();


        if (request.result != UnityWebRequest.Result.Success)
        {
            Debug.Log("Error: " + request.error);
            Debug.Log(request.downloadHandler.text);
            responseText.text = "Error: " + request.error;
        }
        else
        {
            string result = request.downloadHandler.text;
            Debug.Log("Response: " + result);
            try
            {
                var replyData = JsonUtility.FromJson<AIResponse>(result);
                responseText.text = replyData.reply;
                TriggerEmotion(replyData.emotion);
            }
            catch
            {
                responseText.text = "Не удалось";
            }
            
        }
    }

    void TriggerEmotion(string emotion)
    {
        Debug.Log("Эмоция: " + emotion);
        switch (emotion.ToLower())
        {
            case "радость": characterAnimator.SetTrigger("Happy"); break;
            case "грусть": characterAnimator.SetTrigger("Sad"); break;
            case "злость": characterAnimator.SetTrigger("Angry"); break;
            case "удивление": characterAnimator.SetTrigger("Surprised"); break;
            default: characterAnimator.SetTrigger("Neutral"); break;
        }
    }


    [System.Serializable]
    public class AIResponse
    {
        public string reply;
        public string emotion;
    }
}
